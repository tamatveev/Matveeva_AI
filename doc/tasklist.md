# План разработки: LLM-ассистент (Telegram-бот)

## Прогресс

| # | Итерация | Статус | Дата |
|---|---|---|---|
| 1 | Каркас проекта и эхо-бот | ✅ Готово | 2026-02-24 |
| 2 | Подключение LLM | ✅ Готово | 2026-02-24 |
| 3 | Кнопки от LLM | ✅ Готово | 2026-02-24 |
| 4 | Загрузка услуг из Google Sheets | ✅ Готово | 2026-02-24 |
| 5 | Отправка картинок-примеров | ✅ Готово | 2026-02-24 |
| 6 | Оформление заявки | ✅ Готово | 2026-02-24 |
| 7 | Docker и Makefile | ✅ Готово | 2026-02-25 |
| 8 | Деплой в облако | ⬜ Не начата | — |

---

## Итерации

### 1. Каркас проекта и эхо-бот

- [x] Инициализация проекта: `pyproject.toml`, `uv`, `.env.example`, `.gitignore`
- [x] Создать структуру пакета `bot/` с пустыми файлами
- [x] Класс `Config` — чтение `.env`
- [x] Настройка логгирования
- [x] Класс `Bot` — инициализация aiogram, polling
- [x] Класс `Handler` — обработка `/start` и текстовых сообщений
- [x] `Makefile` с командой `make run`
- [x] Бот отвечает эхом на любое сообщение

**Тест:** `make run` запускает бота. Написать боту в Telegram — он отвечает тем же текстом. `/start` отправляет приветствие.

---

### 2. Подключение LLM

- [x] Класс `LLMClient` — отправка запросов в OpenRouter
- [x] Класс `Prompt` — формирование системного промта
- [x] Класс `Handler` — хранение истории диалога в памяти, ограничение по `MAX_HISTORY_MESSAGES`
- [x] Бот отвечает через LLM вместо эхо

**Тест:** написать боту — он отвечает осмысленно через LLM, помнит контекст в рамках диалога. `/start` сбрасывает историю.

---

### 3. Кнопки от LLM

- [x] Парсинг блока `[buttons]...[/buttons]` из ответа LLM
- [x] Отправка inline-кнопок в Telegram
- [x] Обработка нажатия на кнопку как сообщения пользователя
- [x] Инструкция в системном промте: всегда предлагать варианты кнопок

**Тест:** бот отвечает текстом + кнопками. Нажатие на кнопку вызывает следующий ответ с новыми кнопками.

---

### 4. Загрузка услуг из Google Sheets

- [x] Класс `SheetsClient` — авторизация через Service Account, чтение листа «Услуги»
- [x] Кеширование данных в памяти при старте
- [x] Подстановка перечня услуг в системный промт
- [x] LLM отвечает с учётом реальных услуг, цен и сроков

**Тест:** заполнить Google Sheet тестовыми услугами. Бот корректно называет услуги, цены и сроки из таблицы.

---

### 5. Отправка картинок-примеров

- [x] Скачивание картинок с Google Drive по ссылке из таблицы
- [x] Отправка картинки в Telegram при запросе примера работы

**Тест:** запросить пример работы — бот отправляет картинку из Google Drive.

---

### 6. Оформление заявки

- [x] Класс `OrderWriter` — запись строки в лист «Заявки» в Google Sheets
- [x] Сценарий: LLM собирает данные (имя, услуга, почта, комментарий), подтверждение, запись

**Тест:** пройти диалог до оформления заявки — строка появляется в Google Sheet «Заявки».

---

### 7. Docker и Makefile

- [x] `Dockerfile` — сборка образа с `uv` и зависимостями
- [x] `Makefile` — команды `build`, `up`, `down`, `logs`
- [x] Бот работает в Docker-контейнере

**Тест:** `make build && make up` — бот работает в контейнере, отвечает в Telegram.

---

### 8. Деплой в облако (Railway)

- [x] Поддержка деплоя на Railway: переменная `GOOGLE_SERVICE_ACCOUNT_JSON`, инструкция `doc/deploy-railway.md`
- [ ] Создать проект на Railway, подключить репозиторий
- [ ] Задать переменные окружения (в т.ч. `GOOGLE_SERVICE_ACCOUNT_JSON` с содержимым ключа)
- [ ] Бот работает на Railway в режиме 24/7

**Тест:** бот доступен в Telegram и отвечает, работая на Railway.
